<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Manil Bastola | GitHub Projects</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
    body {
      margin: 0;
      font-family: 'Helvetica Neue', sans-serif;
      background-color: #fafafa;
      color: #333;
      display: flex;
      flex-direction: column;
    }
    body.dark-mode {
        background-color: #292727;
        color: #e0e0e0;
    }

    header.hero {
      background-image: url('./site/images/header.jpg');
      background-size: cover;
      background-position: center;
      padding: 15rem 2rem 12rem 2rem;
      text-align: center;
      color: #fff;
    }
    body.dark-mode header.hero {
      background-image: linear-gradient(rgba(0, 15, 30, 0.65), rgba(0, 15, 30, 0.65)), url('./site/images/header.jpg');
      filter: brightness(0.9);
    }

    .theme-toggle-button {
        position: relative;
        top: 0;
        left: 10px; /* (50% of container) - (half of pic width) - (half of button width) */
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(0, 0, 0, 0.1);
        color: #333;
        padding: 0.5rem;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.2rem;
        width: 40px;
        height: 40px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        z-index: 1000;
    }

    .main-wrapper {
      display: flex;
      flex-direction: row;
      justify-content: center;
      gap: 2rem; 
      margin: 2rem auto;
      width: 90%;
      max-width: 1400px;
    }

    .container {
      flex: 3;
    }

    .sidebar {
      flex: 1;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 1rem;
      max-height: fit-content;
      overflow-y: auto;
    }
    body.dark-mode .sidebar {
        background: #1e1e1e;
        box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }

    .sidebar h3 {
      margin-top: 0;
    }

    .tag {
      display: inline-block;
      margin: 0.2rem;
      padding: 0.3rem 0.6rem;
      background-color: #eaeef1;
      color: #140b0b;
      border-radius: 0px;
      font-size: 0.8rem;
      font-weight: bolder;
      cursor: pointer;
      opacity: 70%;
    }

    .tag:hover {
      opacity: 1;
    }

    .tag.active {
      background-color: #0077cc;
      color: white;
      opacity: 1;
    }
    body.dark-mode .tag {
        background-color: #333;
        color: #ccc;
    }

    h2 {
      text-align: center;
      font-size: 2rem;
      margin-bottom: 1rem;
    }

    p.subtitle {
      text-align: center;
      font-size: 1.1rem;
      color: #777;
      margin-bottom: 2rem;
    }
    body.dark-mode p.subtitle {
        color: #aaa;
    }

    .menu{
      text-align: center;
      margin: -40px 0 40px 0;
    }

    .filter-btn {
      padding: 0.5rem 1.2rem;
      font-size: 0.9rem;
      border: 1px solid #ddd;
      border-radius: 2px;
      background-color: #fff;
      cursor: pointer;
      margin: 4px 2px 4px 2px;
      transition: background-color 0.2s, color 0.2s, border-color 0.2s;
      color: #333;
    }
    body.dark-mode .filter-btn {
        background-color: #2c2c2c;
        color: #ccc;
        border-color: #444;
    }

    .filter-btn:hover {
      background-color: #f0f0f0;
    }

    .filter-btn.active {
      background-color: #0077cc;
      color: #fefefe;
      border-color: #000;
      font-weight: bold;
    }
    body.dark-mode .filter-btn.active {
        background-color: #0077cc;
        color: #fff;
        border-color: #0077cc;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
    }

    .card {
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: transform 0.3s ease;
      padding-bottom: 10px;
    }
    body.dark-mode .card {
        background-color: #1e1e1e;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        border: 1px solid #333;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    .card img {
      width: 100%;
      height: 220px;
      object-fit: cover;
    }
    body.dark-mode .card img {
      filter: brightness(0.8) contrast(1.1);
      /*opacity: 0.85;*/
    }


    .card-content {
      padding: 0;
    }

    .card-content h3 {
      margin: 0;
      font-size: 1.1rem;
      text-decoration: none; /* For unvisited links */
      padding-left:5px;
      color: #021e31d7;
      font-weight: bold;
    }
    body.dark-mode .card-content h3 {
        color: #e0e0e0;
    }

    .card a {
      text-decoration: none;
    }

    .card-content p {
      font-size: 0.9rem;
      margin: 0.5rem 0 0 0;
      color: #555;
      padding-left: 5px;
    }
    body.dark-mode .card-content p {
        color: #aaa;
    }

    .card-content a {
      display: inline-block;
      margin-top: 0.7rem;
      color: #021e31;
      font-weight: bold;
      text-decoration: none;
    }

    .card-content a:hover {
      text-decoration: underline;
    }

    #show-more {
      display: block;
      margin: 2rem auto;
      text-align: center;
      padding: 0.7rem 2rem;
      font-size: 1rem;
      border: none;
      border-radius: 5px;
      background-color: #0077cc;
      color: white;
      cursor: pointer;
    }

    .profile-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      margin-top: -10rem;
      position: relative;
      z-index: 1;
      margin-bottom: 2rem;
    }

    .profile-pic {
      width: 20rem;
      height: 20rem;
      border-radius: 50%;
      border: 4px solid white;
      object-fit: cover;
      background-color: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    body.dark-mode .profile-pic {
      filter: brightness(0.8) contrast(1.1);
      opacity: 0.95;
      border-color: #333;
    }

    .contact-line {
      margin-top: 1.5rem;
      font-size: 1rem;
      color: #333;
      line-height: 1.5;
    }
    body.dark-mode .contact-line {
        color: #ccc;
    }

    .contact-line a {
      color: inherit;
      text-decoration: none;
    }

    .contact-line a:hover {
      text-decoration: underline;
    }

    #bio {
      margin-top: 1rem;
      max-width: 720px;
      padding: 0 1rem;
    }

    .divider {
      border: 0;
      height: 1px;
      background-color: #e0e0e0;
      width: 90%;
      max-width: 1400px;
      margin: 0 auto;
    }

    @media (max-width: 992px) {
      .main-wrapper {
        flex-direction: column;
        width: 95%;
      }
      .sidebar {
        margin-top: 2rem;
        max-height: 300px;
      }
    }

    @media (max-width: 768px) {
      .profile-pic {
        width: 15rem;
        height: 15rem;
      }
      .profile-container {
        margin-top: -7.5rem;
      }
    }

    @media (max-width: 480px) {
      .profile-pic {
        width: 10rem;
        height: 10rem;
      }
      .profile-container {
        margin-top: -5rem;
      }
    }
  </style>
</head>
<body>
  <header class="hero">
  </header>

  <div class="profile-container">
    <img class="profile-pic" src="./site/images/prof.jpg" alt="Profile Picture"/>
    <div class="contact-line">
      üíº <a href="https://www.linkedin.com/in/mbastola" target="_blank" rel="noopener noreferrer">linkedin.com/in/mbastola</a> &nbsp;&nbsp;&nbsp; ‚òïÔ∏è <a href="https://github.com/mbastola" target="_blank" rel="noopener noreferrer">github.com/mbastola</a>  <br/><br/>
      üìç Chicago, IL &nbsp;&nbsp;&nbsp; üìçüõ´ Kathmandu, Nepal
    </div>
    <div id="bio">
      <p>
        Senior Machine Learning engineer with a strong background in ML, Computer Vision, 3D & Reinforcement Learning. I build scalable, production-grade AI pipelines and am currently exploring multimodal generative models. This portfolio highlights my personal research interests and experiments.
      </p>
    </div>
  </div>

  <hr class="divider"/>

  <div class="main-wrapper">

    <div class="container">

      <section>
        
        <p class="subtitle"></p>
        <div class="menu">
          <nav>
          <button class="filter-btn active" data-filter="all">All</button>
          <button class="filter-btn" data-filter="nn">Neural Nets</button>
          <button class="filter-btn" data-filter="cv">Vision</button>
          <button class="filter-btn" data-filter="3d">3D</button>
          <button class="filter-btn" data-filter="rl">Reinforcement Learning</button>
          <button class="filter-btn" data-filter="ml">Classical ML</button>
          <button id="theme-toggle" class="theme-toggle-button">
              <i class="fas fa-sun"></i>
          </button><br/>     
          <!--button class="filter-btn" data-filter="ai4s">AI4Science</button>
          <button class="filter-btn" data-filter="genai">Gen AI</button-->
          </nav>
        </div>      
        <div class="grid" id="repo-grid"></div>
        <button id="show-more">Show More</button>
      </section>
      
    </div>
    <aside class="sidebar">
      <h3>Tags</h3>
      <div id="tag-list"></div>
    </aside>
  </div>

  <script>
    let masterProjectList = [];
    let currentProjects = [];
    let visibleCount = 0;
    const tagIndex = {};
    let currentTheme = 'light';

    async function loadProjects() {
      const res = await fetch("./site/projects.json");
      const originalProjects = await res.json();

      // The projects.json is already sorted by date via the Python script.
      // We map the projects to include their original index from the file,
      // ensuring that links to the viewer page work correctly even after filtering by tags.
      masterProjectList = originalProjects.map((proj, index) => ({ ...proj, originalIndex: index }));

      // Sort by most recently updated
      masterProjectList.sort((a, b) => new Date(b.updated) - new Date(a.updated));

      masterProjectList.forEach(proj => {
        if (proj.tags) {
          proj.tags.forEach(tag => {
            if (!tagIndex[tag]) tagIndex[tag] = [];
            tagIndex[tag].push(proj);
          });
        }
      });

      currentProjects = [...masterProjectList];
      populateTags();
      renderProjects(true);
    }

    function toTitleCase(str) {
      return str.replace(
        /\w\S*/g,
        text => text.charAt(0).toUpperCase() + text.substring(1).toLowerCase()
      );
    }


    function populateTags() {
      const tagList = document.getElementById("tag-list");
      const sortedTags = Object.keys(tagIndex).sort((a, b) => tagIndex[b].length - tagIndex[a].length);
      sortedTags.forEach(tag => {
        const tagEl = document.createElement("span");
        tagEl.className = "tag";
        tagEl.textContent = `${toTitleCase(tag)} (${tagIndex[tag].length})`;
        tagEl.onclick = () => {
          // Highlight the clicked tag and deselect others
          document.querySelectorAll('#tag-list .tag').forEach(t => t.classList.remove('active'));
          tagEl.classList.add('active');

          // Reset category filter to 'All' for consistency
          document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
          document.querySelector('.filter-btn[data-filter="all"]').classList.add("active");

          currentProjects = tagIndex[tag];
          renderProjects(true);
        };
        tagList.appendChild(tagEl);
      });
    }

    function renderProjects(clearGrid = false) {
      const grid = document.getElementById("repo-grid");
      if (clearGrid) {
        grid.innerHTML = "";
        visibleCount = 0;
      }

      const limit = 100;
      const next = currentProjects.slice(visibleCount, visibleCount + limit);
      next.forEach((proj, i) => {
        const card = document.createElement("div");
        card.className = "card"
        for ( const cat of proj.category ){
          card.className += ` category-${cat}`;
        }
        const img = document.createElement("img");
        img.src = proj.img;
        img.onerror = () => img.src = "https://placehold.co/400x300";
        img.alt = proj.folder;

        const content = document.createElement("a");
        content.className = "card-content";

        const wrapper = document.createElement("div");

        const title = document.createElement("h3");
        title.textContent = `${proj.folder}`;

        const desc = document.createElement("p");
        desc.textContent = `${new Date(proj.updated).toDateString()}`;

        const projectIndex = proj.originalIndex;
        // Pass the current theme to the viewer page
        const viewerUrl = `project_viewer.html?index=${projectIndex}&theme=${currentTheme}`;
        content.href = viewerUrl;

        content.appendChild(img);
        wrapper.appendChild(title);
        wrapper.appendChild(desc);
        card.appendChild(content);
        content.appendChild(wrapper);
        grid.appendChild(card);
      });

      visibleCount += next.length;
      if (visibleCount >= currentProjects.length) {
        document.getElementById("show-more").style.display = "none";
      } else {
        document.getElementById("show-more").style.display = "block";
      }
    }

    function getSystemTheme() {
        const hour = new Date().getHours();
        // Default to dark mode between 6 PM (18:00) and 6 AM (06:00)
        return (hour >= 18 || hour < 6) ? 'dark' : 'light';
    }

    function setupTheme() {
        const themeToggle = document.getElementById('theme-toggle');
        const urlParams = new URLSearchParams(window.location.search);
        const themeFromUrl = urlParams.get('theme');
        const savedTheme = themeFromUrl || localStorage.getItem('theme') || getSystemTheme();
        currentTheme = savedTheme;

        if (currentTheme === 'dark') {
            document.body.classList.add('dark-mode');
            themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        } else {
            themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
        }

        themeToggle.addEventListener('click', () => {
            if (document.body.classList.contains('dark-mode')) {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
                currentTheme = 'light';
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                // Update card links with the new theme
                updateCardLinks();
            } else {
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
                currentTheme = 'dark';
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                // Update card links with the new theme
                updateCardLinks();
            }
        });
    }

    function updateCardLinks() {
        document.querySelectorAll('.card a').forEach(link => {
            if (link.href.includes('project_viewer.html')) {
                const url = new URL(link.href);
                url.searchParams.set('theme', currentTheme);
                link.href = url.href;
            }
        });
    }

    document.getElementById("show-more").addEventListener("click", renderProjects);
    document.querySelectorAll(".filter-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        // When a category is filtered, deselect any active tag
        document.querySelectorAll('#tag-list .tag').forEach(t => t.classList.remove('active'));

        document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        const filter = btn.getAttribute("data-filter");

        currentProjects = (filter === "all")
          ? [...masterProjectList]
          : masterProjectList.filter(p => p.category && p.category.includes(filter));

        renderProjects(true);
      });
    });

    setupTheme();
    loadProjects();
  </script>
</body>
</html>
